# sageTSDB æ·±åº¦èåˆ PECJ é›†æˆè®¾è®¡æ–‡æ¡£

ç‰ˆæœ¬: v3.0 (Deep Integration Architecture)
æ›´æ–°æ—¥æœŸ: 2024-12-09
åˆ†æ”¯: `pecj_resource_integration`

## å®ç°çŠ¶æ€æ¦‚è§ˆ

| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | è¯´æ˜ |
|------|---------|---------|------|
| åŒæ¨¡å¼æ¶æ„ | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | æ”¯æŒ PLUGIN/INTEGRATED æ¨¡å¼åˆ‡æ¢ |
| PECJComputeEngine | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | æ— çŠ¶æ€è®¡ç®—å¼•æ“ (v3.0) |
| WindowScheduler | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | è‡ªåŠ¨è§¦å‘çª—å£è®¡ç®— |
| ComputeStateManager | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | è®¡ç®—çŠ¶æ€æŒä¹…åŒ– |
| StreamTable | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | è¾“å…¥æµè¡¨ (MemTable + LSM-Tree) |
| JoinResultTable | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | Join ç»“æœè¡¨ |
| ResourceManager | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | èµ„æºç»Ÿä¸€ç®¡ç† |
| PECJAdapter (Plugin) | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | ä¼ ç»Ÿæ’ä»¶æ¨¡å¼ (Baseline) |
| TimeSeriesDB å¤šè¡¨ API | âœ… å·²è®¾è®¡ | âœ… å·²å®ç° | createTable/insert/query |
| EventBus | âš ï¸ éƒ¨åˆ†è®¾è®¡ | âœ… å·²å®ç° | äº‹ä»¶é€šçŸ¥æœºåˆ¶ |
| GPU èµ„æºç®¡ç† | âš ï¸ æ¥å£è®¾è®¡ | âŒ æœªå®ç° | ResourceRequest ä¸­é¢„ç•™ |
| åˆ†å¸ƒå¼è®¡ç®— | âŒ æœªè®¾è®¡ | âŒ æœªå®ç° | åç»­æ‰©å±• |

**ä»£ç å®Œæˆåº¦**: ~85% (æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œæ€§èƒ½ä¼˜åŒ–å’Œåˆ†å¸ƒå¼æ‰©å±•å¾…å®ç°)

## æ‘˜è¦

æœ¬æ–‡æ¡£æè¿°å°† PECJ ä½œä¸º**çº¯è®¡ç®—å¼•æ“**æ·±åº¦èåˆåˆ° sageTSDB çš„æ–¹æ¡ˆã€‚æ ¸å¿ƒåŸåˆ™ï¼š

1. **æ•°æ®å­˜å‚¨ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ•°æ®å¿…é¡»å…ˆå†™å…¥ sageTSDB çš„ Tableï¼ˆMemTable/LSM-Treeï¼‰
2. **èµ„æºå®Œå…¨æ‰˜ç®¡**ï¼šçº¿ç¨‹ã€å†…å­˜ã€GPUã€çŠ¶æ€ç®¡ç†å®Œå…¨ç”± sageTSDB æ§åˆ¶
3. **PECJ æ— çŠ¶æ€åŒ–**ï¼šPECJ ä»…ä½œä¸ºè®¡ç®—å‡½æ•°ï¼Œä¸ç»´æŠ¤è‡ªå·±çš„æ•°æ®ç¼“å†²åŒºå’Œç”Ÿå‘½å‘¨æœŸ
4. **ç»Ÿä¸€æŸ¥è¯¢æ¥å£**ï¼šé€šè¿‡ sageTSDB çš„ Query API è·å–æ•°æ®ï¼Œè€Œéç›´æ¥ feed æ•°æ®åˆ° PECJ

è¿™æ˜¯ä¸€ç§**database-centric**è®¾è®¡ï¼Œè€Œéä¼ ç»Ÿçš„æ’ä»¶æ¨¡å¼ã€‚

## è®¾è®¡ç›®æ ‡

- **æ•°æ®ä¸­å¿ƒåŒ–**ï¼šsageTSDB æ˜¯å”¯ä¸€çš„æ•°æ®çœŸç›¸æ¥æºï¼ˆSingle Source of Truthï¼‰
- **è®¡ç®—æ— çŠ¶æ€åŒ–**ï¼šPECJ ä½œä¸ºçº¯å‡½æ•°è®¡ç®—å¼•æ“ï¼Œä¸æŒæœ‰æ•°æ®çŠ¶æ€
- **èµ„æºç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰ç³»ç»Ÿèµ„æºï¼ˆçº¿ç¨‹ã€å†…å­˜ã€GPUï¼‰ç”± sageTSDB ResourceManager åˆ†é…
- **çŠ¶æ€å¯è§‚æµ‹**ï¼šPECJ çš„æ‰§è¡ŒçŠ¶æ€ã€ä¸­é—´ç»“æœå…¨éƒ¨ç”± sageTSDB ç®¡ç†å’ŒæŒä¹…åŒ–
- **å¯æµ‹è¯•æ€§**ï¼šPECJ çš„è®¡ç®—é€»è¾‘å¯ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–å¤æ‚çš„æ•°æ®ç®¡é“

## ç³»ç»Ÿæ¶æ„å›¾

### æ•´ä½“æ¶æ„ï¼ˆDeep Integration Modeï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          sageTSDB System                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  External Data     â”‚        â”‚  User Applications â”‚                  â”‚
â”‚  â”‚  Sources           â”‚        â”‚                    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚           â”‚                               â”‚                              â”‚
â”‚           â–¼                               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚            TimeSeriesDB (Unified API)               â”‚               â”‚
â”‚  â”‚  â€¢ createTable()  â€¢ insert()  â€¢ query()            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”‚                       â”‚                            â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                            â”‚
â”‚       â–¼                       â–¼            â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚Stream S â”‚  â”‚Stream R  â”‚  â”‚JoinResult     â”‚                        â”‚
â”‚  â”‚Table    â”‚  â”‚Table     â”‚  â”‚Table          â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚       â”‚            â”‚                 â”‚                                 â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚          TableManager (Multi-Table)              â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                 â”‚
â”‚  â”‚  â”‚MemTable    â”‚â†’ â”‚LSM-Tree      â”‚               â”‚                 â”‚
â”‚  â”‚  â”‚(in-memory) â”‚  â”‚(persistence) â”‚               â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                    â”‚                                                    â”‚
â”‚                    â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚         PECJ Deep Integration Layer                      â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚                                                           â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚          â”‚
â”‚  â”‚  â”‚   WindowScheduler (Auto Trigger)        â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Time-based trigger                   â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Count-based trigger                  â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Watermark management                 â”‚           â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â”‚
â”‚  â”‚                 â”‚                                        â”‚          â”‚
â”‚  â”‚                 â–¼                                        â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚          â”‚
â”‚  â”‚  â”‚   PECJComputeEngine (Stateless)         â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ No internal buffer                   â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Query data from tables               â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Execute PECJ algorithm               â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Write results back                   â”‚           â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â”‚
â”‚  â”‚                 â”‚                                        â”‚          â”‚
â”‚  â”‚                 â–¼                                        â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚          â”‚
â”‚  â”‚  â”‚   PECJ Core Algorithm (OoOJoin)         â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ IAWJ / PAWJ / MSWJ                   â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ AQP fallback                         â”‚           â”‚          â”‚
â”‚  â”‚  â”‚  â€¢ Linear SVI / VAE                     â”‚           â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â”‚
â”‚  â”‚                                                           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                    â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         ResourceManager (Unified Control)            â”‚             â”‚
â”‚  â”‚  â€¢ Thread pool allocation                            â”‚             â”‚
â”‚  â”‚  â€¢ Memory quota enforcement                          â”‚             â”‚
â”‚  â”‚  â€¢ GPU device management (reserved)                  â”‚             â”‚
â”‚  â”‚  â€¢ Task scheduling & monitoring                      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                    â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚      ComputeStateManager (Persistence)               â”‚             â”‚
â”‚  â”‚  â€¢ Checkpoint PECJ state                             â”‚             â”‚
â”‚  â”‚  â€¢ Watermark recovery                                â”‚             â”‚
â”‚  â”‚  â€¢ Window progress tracking                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                    â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         EventBus (Notification)                      â”‚             â”‚
â”‚  â”‚  â€¢ Window completed events                           â”‚             â”‚
â”‚  â”‚  â€¢ Error notifications                               â”‚             â”‚
â”‚  â”‚  â€¢ Metrics reporting                                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæ¨¡å¼å¯¹æ¯”æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Plugin Mode (Baseline)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  External Data â†’ PECJAdapter::feedData()                                 â”‚
â”‚                       â”‚                                                    â”‚
â”‚                       â–¼                                                    â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ PECJ Internal      â”‚ â† PECJ manages own buffer & threads    â”‚
â”‚            â”‚ Data Queue         â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ PECJ Worker Thread â”‚ â† PECJ creates own threads             â”‚
â”‚            â”‚ (self-managed)     â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ PECJ Algorithm     â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ Results (callback) â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            sageTSDB (optional storage)                                    â”‚
â”‚                                                                            â”‚
â”‚  Characteristics:                                                          â”‚
â”‚  â€¢ Async feedData() interface                                            â”‚
â”‚  â€¢ PECJ owns data lifecycle                                              â”‚
â”‚  â€¢ 2x memory (PECJ buffer + DB)                                          â”‚
â”‚  â€¢ Fast prototyping                                                      â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Integrated Mode (Production)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  External Data â†’ TimeSeriesDB::insert("stream_s", data)                  â”‚
â”‚                       â”‚                                                    â”‚
â”‚                       â–¼                                                    â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ StreamTable        â”‚ â† Single source of truth               â”‚
â”‚            â”‚ (MemTable + LSM)   â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼ (watch insert events)                              â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ WindowScheduler    â”‚ â† Auto trigger on condition            â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼ (submit task)                                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ ResourceManager    â”‚ â† Unified resource control             â”‚
â”‚            â”‚ Thread Pool        â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼ (execute)                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ PECJComputeEngine  â”‚ â† Stateless compute function           â”‚
â”‚            â”‚ (no buffer/thread) â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â”‚ query data                                         â”‚
â”‚                      â–¼                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ StreamTable query  â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ PECJ Algorithm     â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼ write results                                      â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚            â”‚ JoinResultTable    â”‚                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚            EventBus notification                                          â”‚
â”‚                                                                            â”‚
â”‚  Characteristics:                                                          â”‚
â”‚  â€¢ Sync insert() interface                                               â”‚
â”‚  â€¢ DB owns all data                                                      â”‚
â”‚  â€¢ 1x memory (single storage)                                            â”‚
â”‚  â€¢ Production-grade control                                              â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¶æ„åŸåˆ™

### åŒæ¨¡å¼è®¾è®¡ï¼ˆå…±å­˜ä»¥æ”¯æŒæ€§èƒ½å¯¹æ¯”å®éªŒï¼‰

**âœ… å·²å®ç°**: CMake æ”¯æŒ `-DPECJ_MODE=PLUGIN` å’Œ `-DPECJ_MODE=INTEGRATED`

æœ¬è®¾è®¡æ”¯æŒä¸¤ç§æ¨¡å¼**åŒæ—¶å­˜åœ¨**ï¼Œé€šè¿‡é¢„ç¼–è¯‘å‚æ•°é€‰æ‹©ï¼š

#### æ¨¡å¼ 1ï¼šä¼ ç»Ÿæ’ä»¶æ¨¡å¼ï¼ˆBaselineï¼‰
```
å¤–éƒ¨æ•°æ® â†’ PluginManager â†’ PECJå†…éƒ¨ç¼“å†²åŒº â†’ PECJè®¡ç®— â†’ ç»“æœ
                â†“
            sageTSDBå­˜å‚¨ï¼ˆå¯é€‰ï¼‰
```
**ç‰¹ç‚¹**ï¼š
- PECJ ç»´æŠ¤ç‹¬ç«‹çš„æ•°æ®ç¼“å†²åŒºï¼ˆdata_queue_ï¼‰
- PECJ è‡ªè¡Œåˆ›å»ºå’Œç®¡ç†çº¿ç¨‹
- æ•°æ®å¼‚æ­¥ feedData() æ–¹å¼è¾“å…¥
- é€‚åˆï¼šç‹¬ç«‹è¿è¡Œã€å¿«é€ŸåŸå‹éªŒè¯

**ç¼–è¯‘å‚æ•°**ï¼š`-DPECJ_MODE=PLUGIN`

#### æ¨¡å¼ 2ï¼šæ·±åº¦èåˆæ¨¡å¼ï¼ˆIntegratedï¼‰
```
å¤–éƒ¨æ•°æ® â†’ sageTSDB Table (MemTable/LSM) â†’ PECJ Compute Engine â†’ ç»“æœå†™å›Table
            â†‘                                      â†“
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ResourceManager â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    (çº¿ç¨‹/å†…å­˜/GPU/çŠ¶æ€)
```
**ç‰¹ç‚¹**ï¼š
- æ•°æ®å•ä¸€å­˜å‚¨åœ¨ sageTSDB è¡¨ä¸­
- PECJ æ— çŠ¶æ€çº¯è®¡ç®—å¼•æ“
- èµ„æºç”± ResourceManager ç»Ÿä¸€ç®¡ç†
- é€‚åˆï¼šç”Ÿäº§ç¯å¢ƒã€å¤§è§„æ¨¡éƒ¨ç½²

**ç¼–è¯‘å‚æ•°**ï¼š`-DPECJ_MODE=INTEGRATED`

### æ¨¡å¼å¯¹æ¯”è¡¨

| ç»´åº¦ | æ’ä»¶æ¨¡å¼ (Baseline) | æ·±åº¦èåˆæ¨¡å¼ (Integrated) |
|------|-------------------|------------------------|
| **æ•°æ®å­˜å‚¨** | PECJ ç¼“å†²åŒº + sageTSDB | ä»… sageTSDB è¡¨ |
| **æ•°æ®è¾“å…¥** | `feedData()` å¼‚æ­¥ | `db->insert()` åŒæ­¥ |
| **è®¡ç®—è§¦å‘** | PECJ å†…éƒ¨è½®è¯¢ | WindowScheduler è°ƒåº¦ |
| **çº¿ç¨‹ç®¡ç†** | PECJ è‡ªå»ºçº¿ç¨‹ | ResourceManager çº¿ç¨‹æ±  |
| **å†…å­˜å ç”¨** | 2xï¼ˆé‡å¤å­˜å‚¨ï¼‰ | 1xï¼ˆå•ä¸€å­˜å‚¨ï¼‰ |
| **èµ„æºæ§åˆ¶** | æ— å…¨å±€é…é¢ | ç²¾ç¡®é…é¢é™åˆ¶ |
| **çŠ¶æ€ç®¡ç†** | PECJ å†…éƒ¨çŠ¶æ€ | sageTSDB è¡¨æŒä¹…åŒ– |
| **é€‚ç”¨åœºæ™¯** | åŸå‹éªŒè¯ã€å®éªŒå¯¹æ¯” | ç”Ÿäº§ç¯å¢ƒã€é•¿æœŸè¿è¡Œ |
| **æµ‹è¯•éš”ç¦»** | éœ€è¦å®Œæ•´ sageTSDB | å¯ç‹¬ç«‹æµ‹è¯•è®¡ç®—é€»è¾‘ |

## å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆéœ€è¦åŒæ¨¡å¼ï¼Ÿ

| éœ€æ±‚ | æ’ä»¶æ¨¡å¼çš„ä¼˜åŠ¿ | æ·±åº¦èåˆæ¨¡å¼çš„ä¼˜åŠ¿ |
|------|--------------|------------------|
| **å®éªŒå¯¹æ¯”** | æä¾›æ€§èƒ½åŸºå‡†ï¼ˆBaselineï¼‰ | éªŒè¯ä¼˜åŒ–æ•ˆæœ |
| **çµæ´»æ€§** | å¿«é€Ÿè¿­ä»£ã€ç‹¬ç«‹è°ƒè¯• | ç”Ÿäº§çº§ç¨³å®šæ€§ |
| **å…¼å®¹æ€§** | å…¼å®¹ç°æœ‰ PECJ ä»£ç  | æ·±åº¦é›†æˆ sageTSDB ç‰¹æ€§ |
| **éƒ¨ç½²åœºæ™¯** | è¾¹ç¼˜è®¾å¤‡ã€å•æœºéƒ¨ç½² | æ•°æ®ä¸­å¿ƒã€é›†ç¾¤éƒ¨ç½² |
| **å¼€å‘æµ‹è¯•** | æ— éœ€å®Œæ•´ sageTSDB ç¯å¢ƒ | é›†æˆæµ‹è¯•æ›´çœŸå® |

### åŒæ¨¡å¼å®éªŒå¯¹æ¯”çš„ä»·å€¼

**å¯¹æ¯”ç»´åº¦**ï¼š
1. **ååé‡**ï¼šæ¯ç§’å¤„ç†çš„äº‹ä»¶æ•° (events/sec)
2. **å»¶è¿Ÿ**ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿåˆ†å¸ƒ (P50, P99, P999)
3. **å†…å­˜å ç”¨**ï¼šå³°å€¼å†…å­˜å’Œå¹³å‡å†…å­˜ (MB)
4. **CPU åˆ©ç”¨ç‡**ï¼šçº¿ç¨‹æ•°å’Œ CPU ä½¿ç”¨ç‡ (%)
5. **å¯æ‰©å±•æ€§**ï¼šå¢åŠ æµæ•°é‡æ—¶çš„æ€§èƒ½è¡°å‡
6. **æ•…éšœæ¢å¤**ï¼šé‡å¯åæ¢å¤æ—¶é—´ (ms)

**å®éªŒå‚æ•°**ï¼š
- æ•°æ®è§„æ¨¡ï¼š1M, 10M, 100M äº‹ä»¶
- çª—å£å¤§å°ï¼š1s, 5s, 10s
- ä¹±åºç¨‹åº¦ï¼š0%, 10%, 30%
- å¹¶å‘æµæ•°ï¼š2, 4, 8

### æ ¸å¿ƒçº¦æŸ

1. **PECJ ä¸æŒæœ‰æ•°æ®**
   - æ‰€æœ‰è¾“å…¥æ•°æ®ä» sageTSDB è¡¨æŸ¥è¯¢
   - è®¡ç®—ä¸­é—´çŠ¶æ€ä¹Ÿå­˜å‚¨åœ¨è¡¨ä¸­ï¼ˆè€Œéå†…å­˜ï¼‰
   - ç»“æœç«‹å³å†™å›è¡¨

2. **PECJ ä¸åˆ›å»ºçº¿ç¨‹**
   - ä½¿ç”¨ `ResourceHandle::submitTask()` æäº¤ä»»åŠ¡
   - sageTSDB çš„çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡
   - çº¿ç¨‹æ•°ä¸¥æ ¼å— `ResourceRequest::requested_threads` é™åˆ¶

3. **PECJ ä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**
   - ç”± sageTSDB çš„ `ComputeScheduler` è°ƒåº¦æ‰§è¡Œ
   - å¤±è´¥é‡è¯•ç”± sageTSDB æ§åˆ¶
   - æ²¡æœ‰ç‹¬ç«‹çš„ start/stop è¯­ä¹‰

## æ ¸å¿ƒç»„ä»¶è®¾è®¡

**å®ç°è¯´æ˜**: ä»¥ä¸‹æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å‡å·²å®ç°ï¼Œä»£ç ä½äºï¼š
- `include/sage_tsdb/compute/`: è®¡ç®—å¼•æ“å¤´æ–‡ä»¶
- `src/compute/`: è®¡ç®—å¼•æ“å®ç°
- `include/sage_tsdb/core/`: æ ¸å¿ƒè¡¨å’Œæ•°æ®åº“æ¥å£
- `src/core/`: æ ¸å¿ƒå®ç°

### 1. æ•°æ®æµæ¶æ„

**âœ… å·²å®ç°**: StreamTableã€JoinResultTableã€TimeSeriesDB å¤šè¡¨ API å‡å·²å®Œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        sageTSDB Core                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¤–éƒ¨æ•°æ®                                                     â”‚
â”‚     â†“                                                        â”‚
â”‚  [MemTable] â†’ [Immutable MemTable] â†’ [LSM-Tree Level 0-N]  â”‚
â”‚     â†“            â†“                      â†“                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                  â†“                                           â”‚
â”‚          [TimeSeriesDB Query API]                           â”‚
â”‚                  â†“                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚     â†“                           â†“                            â”‚
â”‚ [Stream S Table]          [Stream R Table]                  â”‚
â”‚     â†“                           â†“                            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                  â†“                                           â”‚
â”‚         [PECJ Compute Engine]                               â”‚
â”‚           (æ— çŠ¶æ€è®¡ç®—å‡½æ•°)                                     â”‚
â”‚                  â†“                                           â”‚
â”‚         [Join Result Table]                                 â”‚
â”‚                  â†“                                           â”‚
â”‚         [EventBus é€šçŸ¥ä¸‹æ¸¸]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®çº¦æŸï¼š
1. **æ•°æ®å¿…é¡»å…ˆå…¥è¡¨**ï¼šå¤–éƒ¨æ•°æ®å…ˆå†™å…¥ `StreamSTable` æˆ– `StreamRTable`
2. **PECJ ä»è¡¨è¯»å–**ï¼šé€šè¿‡ `TimeSeriesDB::query()` è·å–çª—å£å†…æ•°æ®
3. **ç»“æœå†™å›è¡¨**ï¼šJoin ç»“æœå†™å…¥ `JoinResultTable`ï¼Œä¸ç›´æ¥è¿”å›ç»™è°ƒç”¨æ–¹

### 2. PECJ è®¡ç®—å¼•æ“æ¥å£ï¼ˆæ–°è®¾è®¡ï¼‰

**âœ… å·²å®ç°**: `include/sage_tsdb/compute/pecj_compute_engine.h` å’Œ `src/compute/pecj_compute_engine.cpp`

**å®ç°å®Œæˆåº¦**:
- âœ… æ ¸å¿ƒæ¥å£ (initialize, executeWindowJoin, getMetrics, reset)
- âœ… æ•°æ®æ ¼å¼è½¬æ¢ (convertFromTable, convertToTable)
- âœ… è¶…æ—¶ä¿æŠ¤ (executeWithTimeout)
- âœ… AQP é™çº§ (fallbackToAQP)
- âœ… æŒ‡æ ‡æ”¶é›† (updateMetrics)
- âœ… å†…å­˜é™åˆ¶æ£€æŸ¥ (checkMemoryLimit)
- âš ï¸ æ¡ä»¶ç¼–è¯‘æ”¯æŒ (PECJ_MODE_INTEGRATED, PECJ_FULL_INTEGRATION)

PECJ ä¸å†æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„æ’ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ª**çº¯å‡½æ•°è®¡ç®—å¼•æ“**ï¼š

```cpp
namespace sage_tsdb {
namespace compute {

/**
 * @brief PECJ è®¡ç®—å¼•æ“ï¼ˆæ— çŠ¶æ€ï¼‰
 * 
 * è®¾è®¡åŸåˆ™ï¼š
 * - ä¸æŒæœ‰ä»»ä½•æ•°æ®ç¼“å†²åŒº
 * - ä¸åˆ›å»ºçº¿ç¨‹ï¼ˆä½¿ç”¨ ResourceHandle æäº¤ä»»åŠ¡ï¼‰
 * - ä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆç”± sageTSDB è°ƒåº¦ï¼‰
 * - è®¡ç®—ç»“æœå†™å› sageTSDB è¡¨
 */
class PECJComputeEngine {
public:
    /**
     * @brief åˆå§‹åŒ–è®¡ç®—å¼•æ“ï¼ˆä¸€æ¬¡æ€§é…ç½®ï¼‰
     * @param config ç®—æ³•å‚æ•°ï¼ˆçª—å£å¤§å°ã€å»¶è¿Ÿé˜ˆå€¼ç­‰ï¼‰
     * @param db æŒ‡å‘ TimeSeriesDB çš„å¼•ç”¨ï¼ˆç”¨äºè¯»å†™æ•°æ®ï¼‰
     * @param resource_handle èµ„æºå¥æŸ„ï¼ˆç”¨äºæäº¤è®¡ç®—ä»»åŠ¡ï¼‰
     */
    bool initialize(const ComputeConfig& config,
                   TimeSeriesDB* db,
                   ResourceHandle* resource_handle);
    
    /**
     * @brief æ‰§è¡Œçª—å£ Join è®¡ç®—ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰
     * @param window_id çª—å£æ ‡è¯†ç¬¦
     * @param time_range æ—¶é—´èŒƒå›´ [start, end)
     * @return è®¡ç®—çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥/éƒ¨åˆ†å®Œæˆï¼‰
     * 
     * æ‰§è¡Œæµç¨‹ï¼š
     * 1. ä» db æŸ¥è¯¢ StreamS å’Œ StreamR åœ¨ time_range å†…çš„æ•°æ®
     * 2. è°ƒç”¨ PECJ æ ¸å¿ƒç®—æ³•æ‰§è¡Œ Join
     * 3. å°†ç»“æœå†™å…¥ db çš„ JoinResultTable
     * 4. è¿”å›è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
     */
    ComputeStatus executeWindowJoin(uint64_t window_id,
                                    const TimeRange& time_range);
    
    /**
     * @brief è·å–è®¡ç®—ç»Ÿè®¡ï¼ˆèµ„æºä½¿ç”¨ã€å»¶è¿Ÿç­‰ï¼‰
     */
    ComputeMetrics getMetrics() const;
    
    /**
     * @brief é‡ç½®è®¡ç®—çŠ¶æ€ï¼ˆæ¸…é™¤ç¼“å­˜ã€é‡ç½®è®¡æ•°å™¨ï¼‰
     */
    void reset();

private:
    TimeSeriesDB* db_;                        // æ•°æ®åº“å¼•ç”¨ï¼ˆä¸æ‹¥æœ‰ï¼‰
    ResourceHandle* resource_handle_;         // èµ„æºå¥æŸ„ï¼ˆä¸æ‹¥æœ‰ï¼‰
    ComputeConfig config_;                    // ç®—æ³•é…ç½®
    
    // PECJ æ ¸å¿ƒç®—æ³•å¯¹è±¡ï¼ˆè½»é‡çº§ï¼Œæ— çŠ¶æ€ï¼‰
    std::unique_ptr<OoOJoin::AbstractOperator> pecj_operator_;
};

} // namespace compute
} // namespace sage_tsdb
```

### 3. sageTSDB è¡¨è®¾è®¡

**âœ… å·²å®ç°**: æ‰€æœ‰è¡¨ç±»å‹å‡å·²å®ç°

**å®ç°æ–‡ä»¶**:
- `include/sage_tsdb/core/stream_table.h` + `src/core/stream_table.cpp`
- `include/sage_tsdb/core/join_result_table.h` + `src/core/join_result_table.cpp`
- `include/sage_tsdb/core/lsm_tree.h` + `src/core/lsm_tree.cpp` (æŒä¹…åŒ–æ”¯æŒ)

#### 3.1 Stream è¡¨ï¼ˆè¾“å…¥ï¼‰

**âœ… å·²å®ç°**: å®Œæ•´çš„ MemTable + LSM-Tree æ¶æ„
```cpp
// Stream S å’Œ Stream R å„è‡ªç‹¬ç«‹çš„è¡¨
class StreamTable {
public:
    // æ ‡å‡† sageTSDB è¡¨æ¥å£
    size_t insert(const TimeSeriesData& data);
    std::vector<TimeSeriesData> query(const TimeRange& range, 
                                      const Tags& filter_tags = {});
    void createIndex(const std::string& field_name);
    
    // çª—å£è¯­ä¹‰æ”¯æŒ
    std::vector<TimeSeriesData> queryWindow(uint64_t window_id);
};

// sageTSDB ä¸­æ³¨å†Œä¸¤ä¸ªè¡¨
db->createTable("stream_s", StreamTable);
db->createTable("stream_r", StreamTable);
```

#### 3.2 Join ç»“æœè¡¨ï¼ˆè¾“å‡ºï¼‰

**âœ… å·²å®ç°**: æ”¯æŒè¯¦ç»†çš„ Join ç»“æœå­˜å‚¨å’ŒæŸ¥è¯¢

**å®ç°ç‰¹æ€§**:
- âœ… JoinRecord ç»“æ„ (window_id, join_count, aqp_estimate, payload)
- âœ… è®¡ç®—æŒ‡æ ‡å­˜å‚¨ (computation_time, memory_used, threads_used)
- âœ… Payload åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… æŒ‰çª—å£å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… æ ‡ç­¾è¿‡æ»¤æ”¯æŒ
```cpp
class JoinResultTable {
public:
    // å­˜å‚¨ Join ç»“æœçš„ç»“æ„
    struct JoinRecord {
        uint64_t window_id;
        int64_t timestamp;
        size_t join_count;        // ç²¾ç¡® Join ç»“æœæ•°
        double aqp_estimate;      // AQP ä¼°è®¡å€¼
        std::vector<uint8_t> payload;  // åºåˆ—åŒ–çš„è¯¦ç»†ç»“æœ
    };
    
    size_t insertJoinResult(const JoinRecord& record);
    std::vector<JoinRecord> queryByWindow(uint64_t window_id);
};
```

### 4. ResourceManager æ·±åº¦é›†æˆ

**âœ… å·²å®ç°**: `include/sage_tsdb/plugins/resource_manager.h` å’Œ `src/plugins/resource_manager.cpp`

**å®ç°å®Œæˆåº¦**:
- âœ… èµ„æºåˆ†é…æ¥å£ (allocate, release)
- âœ… çº¿ç¨‹æ± ç®¡ç† (submitTask)
- âœ… å†…å­˜é…é¢æ§åˆ¶ (max_memory_bytes, critical_memory_bytes)
- âœ… ä½¿ç”¨æƒ…å†µç›‘æ§ (queryUsage, getTotalUsage)
- âœ… ä¼˜å…ˆçº§è°ƒåº¦ (priority hint)
- âš ï¸ GPU èµ„æºç®¡ç† (æ¥å£å·²é¢„ç•™ï¼Œå®ç°å¾…å®Œæˆ)

**æ–°å¢ä½†æ–‡æ¡£æœªæåŠçš„åŠŸèƒ½**:
- âœ… ResourceHandle::isValid() - èµ„æºå¥æŸ„æœ‰æ•ˆæ€§æ£€æŸ¥
- âœ… ResourceHandle::getAllocated() - æŸ¥è¯¢å®é™…åˆ†é…çš„èµ„æº
- âœ… åŠ¨æ€é…é¢è°ƒæ•´ (adjustQuota) - è¿è¡Œæ—¶ä¿®æ”¹èµ„æºé™åˆ¶

```cpp
class ResourceManager {
public:
    /**
     * @brief ä¸º PECJ åˆ†é…è®¡ç®—èµ„æº
     * @param compute_name è®¡ç®—å¼•æ“åç§°ï¼ˆå¦‚ "pecj_engine"ï¼‰
     * @param request èµ„æºè¯·æ±‚
     * @return èµ„æºå¥æŸ„
     */
    std::shared_ptr<ResourceHandle> allocateForCompute(
        const std::string& compute_name,
        const ResourceRequest& request);
    
    /**
     * @brief ç›‘æ§ PECJ èµ„æºä½¿ç”¨
     */
    ResourceUsage getComputeUsage(const std::string& compute_name) const;
    
    /**
     * @brief å¼ºåˆ¶é™æµï¼ˆå½“èµ„æºè¶…é™æ—¶ï¼‰
     */
    void throttleCompute(const std::string& compute_name, double factor);
};
```

### 5. WindowSchedulerï¼ˆçª—å£è°ƒåº¦å™¨ï¼‰

**âœ… å·²å®ç°**: `include/sage_tsdb/compute/window_scheduler.h` å’Œ `src/compute/window_scheduler.cpp`

**å®ç°å®Œæˆåº¦**:
- âœ… è§¦å‘ç­–ç•¥ (TimeBased, CountBased, Hybrid, Manual)
- âœ… çª—å£ç±»å‹ (Tumbling, Sliding, Session)
- âœ… Watermark ç®¡ç†
- âœ… å»¶è¿Ÿæ•°æ®å¤„ç†
- âœ… å¹¶å‘çª—å£æ§åˆ¶
- âœ… è‡ªé€‚åº”è°ƒåº¦ (enable_adaptive_scheduling)
- âœ… çª—å£çŠ¶æ€è·Ÿè¸ª (WindowInfo)
- âœ… è°ƒåº¦æŒ‡æ ‡æ”¶é›† (SchedulingMetrics)
- âœ… å›è°ƒé€šçŸ¥æœºåˆ¶ (WindowCallback)

**è®¾è®¡æ–‡æ¡£ä¸­æœªè¯¦ç»†æè¿°ä½†å·²å®ç°çš„åŠŸèƒ½**:
- âœ… è¡¨æ’å…¥ç›‘å¬ (watchTable)
- âœ… å¾…å¤„ç†çª—å£é˜Ÿåˆ— (max_pending_windows)
- âœ… çª—å£ç”Ÿå‘½å‘¨æœŸç®¡ç† (created_at, triggered_at, completed_at)
- âœ… å»¶è¿Ÿæ•°æ®é‡è®¡ç®— (late_windows_recomputed)

### 6. çŠ¶æ€ç®¡ç†ï¼ˆç”± sageTSDB è´Ÿè´£ï¼‰

**âœ… å·²å®ç°**: `include/sage_tsdb/compute/compute_state_manager.h` å’Œ `src/compute/compute_state_manager.cpp`

**å®ç°å®Œæˆåº¦**:
- âœ… çŠ¶æ€ä¿å­˜/åŠ è½½ (saveState, loadState)
- âœ… çŠ¶æ€å­˜åœ¨æ€§æ£€æŸ¥ (hasState)
- âœ… çŠ¶æ€åˆ é™¤ (deleteState)
- âœ… æŒä¹…åŒ–åˆ°ç£ç›˜ (persistState)
- âœ… çŠ¶æ€æ¢å¤ (recoverState)
- âœ… çŠ¶æ€ç‰ˆæœ¬ç®¡ç†
- âœ… çº¿ç¨‹å®‰å…¨è®¿é—®

```cpp
class ComputeStateManager {
public:
    /**
     * @brief ä¿å­˜ PECJ ä¸­é—´çŠ¶æ€åˆ°è¡¨
     * @param compute_name è®¡ç®—å¼•æ“åç§°
     * @param state çŠ¶æ€æ•°æ®ï¼ˆåºåˆ—åŒ–åï¼‰
     */
    bool saveState(const std::string& compute_name, 
                  const std::vector<uint8_t>& state);
    
    /**
     * @brief æ¢å¤ PECJ çŠ¶æ€
     */
    std::vector<uint8_t> loadState(const std::string& compute_name);
    
    /**
     * @brief æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆé€šè¿‡ LSM-Treeï¼‰
     */
    bool persistState(const std::string& compute_name);
};
```

### 7. EventBusï¼ˆäº‹ä»¶é€šçŸ¥ï¼‰

**âœ… å·²å®ç°**: `include/sage_tsdb/plugins/event_bus.h`

**å®ç°å®Œæˆåº¦**:
- âœ… äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœºåˆ¶
- âœ… çª—å£å®Œæˆé€šçŸ¥
- âœ… é”™è¯¯é€šçŸ¥
- âœ… æŒ‡æ ‡æŠ¥å‘Šäº‹ä»¶
- âœ… å¤šè®¢é˜…è€…æ”¯æŒ
- âœ… çº¿ç¨‹å®‰å…¨

**è®¾è®¡æ–‡æ¡£ä¸­æœªæåŠä½†å·²å®ç°**:
- âœ… äº‹ä»¶ä¼˜å…ˆçº§
- âœ… äº‹ä»¶è¿‡æ»¤å™¨
- âœ… å¼‚æ­¥äº‹ä»¶å¤„ç†

### 8. PECJAdapterï¼ˆæ’ä»¶æ¨¡å¼ï¼‰

**âœ… å·²å®ç°**: `include/sage_tsdb/plugins/adapters/pecj_adapter.h` å’Œ `src/plugins/adapters/pecj_adapter.cpp`

**å®ç°å®Œæˆåº¦**:
- âœ… å¼‚æ­¥æ•°æ®è¾“å…¥ (feedStreamS, feedStreamR)
- âœ… å†…éƒ¨æ•°æ®é˜Ÿåˆ—ç®¡ç†
- âœ… ç‹¬ç«‹å·¥ä½œçº¿ç¨‹
- âœ… çª—å£é…ç½® (WindowConfig)
- âœ… å¤šç§ç®—å­æ”¯æŒ (IAWJ, MSWJ, AI, LINEAR_SVI ç­‰)
- âœ… ResourceManager é›†æˆ
- âœ… äº‹ä»¶å›è°ƒæœºåˆ¶
- âœ… æ€§èƒ½æŒ‡æ ‡æ”¶é›†

## ä½¿ç”¨ç¤ºä¾‹

**ğŸ“ ç¤ºä¾‹ä»£ç å¯è¿è¡Œ**: å®Œæ•´ç¤ºä¾‹ä½äº `examples/deep_integration_demo.cpp` å’Œ `examples/window_scheduler_demo.cpp`

### åœºæ™¯ï¼šå®æ—¶è‚¡ç¥¨äº¤æ˜“æµ Join

```cpp
// 1. åˆå§‹åŒ– sageTSDB
TimeSeriesDB db;
db.enablePersistence("/data/sage_tsdb");

// 2. åˆ›å»º Stream è¡¨
db.createTable("stock_orders", TableType::TimeSeries);
db.createTable("stock_trades", TableType::TimeSeries);
db.createTable("join_results", TableType::TimeSeries);

// 3. åˆå§‹åŒ– PECJ è®¡ç®—å¼•æ“
ComputeConfig pecj_config;
pecj_config.window_len_us = 1000000;  // 1ç§’çª—å£
pecj_config.slide_len_us = 500000;    // 500ms æ»‘åŠ¨
pecj_config.operator_type = OperatorType::IAWJ;

ResourceRequest resource_req;
resource_req.requested_threads = 4;
resource_req.max_memory_bytes = 2ULL * 1024 * 1024 * 1024;  // 2GB

auto resource_handle = db.getResourceManager()->allocateForCompute(
    "pecj_engine", resource_req);

PECJComputeEngine pecj_engine;
pecj_engine.initialize(pecj_config, &db, resource_handle.get());

// 4. æ•°æ®å†™å…¥ï¼ˆç”±å¤–éƒ¨æ•°æ®æºé©±åŠ¨ï¼‰
void onOrderData(const TimeSeriesData& data) {
    db.insert("stock_orders", data);
}

void onTradeData(const TimeSeriesData& data) {
    db.insert("stock_trades", data);
}

// 5. å®šæœŸè§¦å‘çª—å£è®¡ç®—ï¼ˆç”± sageTSDB çš„ WindowScheduler é©±åŠ¨ï¼‰
void onWindowTrigger(uint64_t window_id, const TimeRange& range) {
    // å¼‚æ­¥æäº¤è®¡ç®—ä»»åŠ¡ï¼ˆä¸é˜»å¡æ•°æ®å†™å…¥ï¼‰
    resource_handle->submitTask([&, window_id, range]() {
        auto status = pecj_engine.executeWindowJoin(window_id, range);
        
        if (status.success) {
            // ç»“æœå·²å†™å…¥ join_results è¡¨
            LOG_INFO("Window {} completed: {} joins", 
                     window_id, status.join_count);
            
            // é€šçŸ¥ä¸‹æ¸¸åº”ç”¨ï¼ˆå¯é€‰ï¼‰
            db.getEventBus()->publish("window_completed", status);
        }
    });
}

// 6. æŸ¥è¯¢ Join ç»“æœ
auto results = db.query("join_results", QueryConfig{
    .time_range = {now - 3600000, now},  // æœ€è¿‘1å°æ—¶
    .filter_tags = {{"symbol", "AAPL"}}
});

// 7. ç›‘æ§èµ„æºä½¿ç”¨
auto metrics = db.getResourceManager()->getComputeUsage("pecj_engine");
LOG_INFO("PECJ: threads={}, memory={}MB, latency={}ms",
         metrics.threads_used,
         metrics.memory_used_bytes / 1024 / 1024,
         metrics.avg_latency_ms);
```

## å®æ–½è·¯çº¿ï¼ˆåˆ†é˜¶æ®µè¿ç§»ï¼‰

### Phase 1: åŸºç¡€è®¾æ–½å‡†å¤‡ï¼ˆ1-2å‘¨ï¼‰
1. **æ‰©å±• TimeSeriesDB æ¥å£**
   - æ·»åŠ  `createTable(name, type)` API
   - æ”¯æŒå¤šè¡¨ç‹¬ç«‹å­˜å‚¨ï¼ˆstream_s, stream_r, join_resultsï¼‰
   - å®ç°è¡¨çº§åˆ«çš„ query/insert

2. **å®ç° ComputeStateManager**
   - çŠ¶æ€åºåˆ—åŒ–/ååºåˆ—åŒ–
   - é€šè¿‡ LSM-Tree æŒä¹…åŒ–

3. **æ‰©å±• ResourceManager**
   - æ·»åŠ  `allocateForCompute()` æ¥å£
   - å®ç°è®¡ç®—ä»»åŠ¡çš„èµ„æºéš”ç¦»

### Phase 2: PECJ æ— çŠ¶æ€åŒ–æ”¹é€ ï¼ˆ2-3å‘¨ï¼‰
1. **é‡æ„ PECJAdapter â†’ PECJComputeEngine**
   - ç§»é™¤å†…éƒ¨æ•°æ®é˜Ÿåˆ—ï¼ˆ`data_queue_`ï¼‰
   - ç§»é™¤å·¥ä½œçº¿ç¨‹ï¼ˆ`worker_thread_`ï¼‰
   - ä»…ä¿ç•™æ ¸å¿ƒç®—æ³•è°ƒç”¨

2. **å®ç°æ•°æ®é€‚é…å±‚**
   ```cpp
   // ä» sageTSDB æ ¼å¼è½¬æ¢ä¸º PECJ TrackTuple
   std::vector<TrackTuple> convertFromTable(
       const std::vector<TimeSeriesData>& db_data);
   
   // ä» PECJ ç»“æœè½¬æ¢ä¸º sageTSDB æ ¼å¼
   std::vector<TimeSeriesData> convertToTable(
       const JoinResult& pecj_result);
   ```

3. **é›†æˆæµ‹è¯•**
   - å•å…ƒæµ‹è¯•ï¼šéªŒè¯è®¡ç®—æ­£ç¡®æ€§ï¼ˆä¸ä¾èµ– sageTSDBï¼‰
   - é›†æˆæµ‹è¯•ï¼šéªŒè¯ sageTSDB è¡¨è¯»å†™ä¸€è‡´æ€§

### Phase 3: çª—å£è°ƒåº¦é›†æˆï¼ˆ1-2å‘¨ï¼‰
1. **å®ç° WindowScheduler**
   ```cpp
   class WindowScheduler {
   public:
       // åŸºäºæ—¶é—´æˆ–æ•°æ®é‡è§¦å‘çª—å£è®¡ç®—
       void scheduleWindow(uint64_t window_id, const TimeRange& range);
       
       // ç›‘å¬è¡¨çš„æ’å…¥äº‹ä»¶ï¼Œè‡ªåŠ¨è§¦å‘çª—å£
       void watchTable(const std::string& table_name);
   };
   ```

2. **äº‹ä»¶é©±åŠ¨é›†æˆ**
   - æ•°æ®æ’å…¥ â†’ è§¦å‘çª—å£æ£€æŸ¥
   - çª—å£å®Œæ•´ â†’ æäº¤ PECJ è®¡ç®—ä»»åŠ¡
   - è®¡ç®—å®Œæˆ â†’ å‘å¸ƒ EventBus é€šçŸ¥

### Phase 4: æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ï¼ˆ1å‘¨ï¼‰
1. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**
   - é¢„å–çª—å£æ•°æ®åˆ° MemTable
   - SIMD åŠ é€Ÿæ•°æ®è½¬æ¢

2. **èµ„æºç›‘æ§å®Œå–„**
   - å®æ—¶ç›‘æ§ PECJ è®¡ç®—å»¶è¿Ÿ
   - è‡ªåŠ¨é™çº§ï¼ˆè¶…æ—¶åˆ‡æ¢åˆ° AQP æ¨¡å¼ï¼‰

3. **æŒä¹…åŒ–ç­–ç•¥**
   - å®šæœŸ checkpoint PECJ çŠ¶æ€
   - æ”¯æŒæ•…éšœæ¢å¤

## è¿ç§»å¯¹æ¯”

| ç»´åº¦ | æ—§æ’ä»¶æ¨¡å¼ | æ–°æ·±åº¦èåˆæ¨¡å¼ |
|------|-----------|---------------|
| **æ•°æ®å­˜å‚¨** | PECJ å†…éƒ¨ç¼“å†²åŒº + sageTSDB | ä»… sageTSDB Table |
| **èµ„æºç®¡ç†** | PECJ è‡ªè¡Œåˆ›å»ºçº¿ç¨‹ | sageTSDB ResourceManager |
| **çŠ¶æ€ç®¡ç†** | PECJ å†…éƒ¨çŠ¶æ€ | sageTSDB ComputeStateManager |
| **æ¥å£æ¨¡å¼** | å¼‚æ­¥ feedData() | åŒæ­¥ executeWindowJoin() |
| **æµ‹è¯•éš”ç¦»** | éœ€è¦å®Œæ•´ sageTSDB | å¯ç‹¬ç«‹æµ‹è¯•è®¡ç®—é€»è¾‘ |
| **å†…å­˜å ç”¨** | åŒä»½æ•°æ®ï¼ˆPECJ + DBï¼‰ | å•ä»½æ•°æ® |
| **æ•…éšœæ¢å¤** | å¤æ‚ï¼ˆéœ€æ¢å¤ PECJ çŠ¶æ€ï¼‰ | ç®€å•ï¼ˆä»…æ¢å¤è¡¨æ•°æ®ï¼‰ |

## éªŒè¯è¦ç‚¹ï¼ˆéªŒæ”¶å‡†åˆ™ï¼‰

### åŠŸèƒ½éªŒè¯
- [âœ…] æ•°æ®å†™å…¥ stream_s/stream_r è¡¨åå¯æŸ¥è¯¢ - **å·²éªŒè¯**: `examples/deep_integration_demo.cpp`
- [âœ…] PECJ èƒ½ä»è¡¨ä¸­æ­£ç¡®è¯»å–çª—å£æ•°æ® - **å·²å®ç°**: `PECJComputeEngine::executeWindowJoin()`
- [âœ…] Join ç»“æœæ­£ç¡®å†™å…¥ join_results è¡¨ - **å·²å®ç°**: `writeResults()` æ–¹æ³•
- [âœ…] WindowScheduler èƒ½è‡ªåŠ¨è§¦å‘çª—å£è®¡ç®— - **å·²éªŒè¯**: `examples/window_scheduler_demo.cpp`
- [âš ï¸] æ”¯æŒå¤šçª—å£å¹¶å‘è®¡ç®—ï¼ˆèµ„æºéš”ç¦»ï¼‰ - **éƒ¨åˆ†éªŒè¯**: ResourceManager æ”¯æŒï¼Œéœ€è¦é›†æˆæµ‹è¯•

### æ€§èƒ½éªŒè¯
- [â³] ååé‡ä¸ä½äºæ—§æ¨¡å¼çš„ 90% - **å¾…æµ‹è¯•**: éœ€è¿è¡Œ `performance_benchmark`
- [â³] ç«¯åˆ°ç«¯å»¶è¿Ÿï¼ˆæ•°æ®å†™å…¥ â†’ Join å®Œæˆï¼‰<100ms (P99) - **å¾…æµ‹è¯•**
- [â³] å†…å­˜å ç”¨å‡å°‘ 30%+ï¼ˆæ¶ˆé™¤é‡å¤ç¼“å†²ï¼‰ - **å¾…æµ‹è¯•**
- [âœ…] çº¿ç¨‹æ•°ç²¾ç¡®æ§åˆ¶åœ¨é…é¢å†… - **å·²å®ç°**: ResourceManager å¼ºåˆ¶æ‰§è¡Œ

### å¯é æ€§éªŒè¯
- [âœ…] æ”¯æŒ PECJ è®¡ç®—å¤±è´¥åé‡è¯•ï¼ˆä»è¡¨é‡æ–°è¯»å–ï¼‰ - **å·²å®ç°**: `executeWindowJoin()` å¼‚å¸¸å¤„ç†
- [âœ…] æ”¯æŒ sageTSDB é‡å¯åçŠ¶æ€æ¢å¤ - **å·²å®ç°**: `ComputeStateManager::recoverState()`
- [âš ï¸] èµ„æºè¶…é™æ—¶è‡ªåŠ¨é™çº§ï¼ˆAQP æ¨¡å¼ï¼‰ - **éƒ¨åˆ†å®ç°**: `fallbackToAQP()` å·²æœ‰ï¼Œè§¦å‘é€»è¾‘éœ€å®Œå–„
- [âœ…] ç›‘æ§æŒ‡æ ‡å®Œæ•´ï¼ˆå»¶è¿Ÿã€ååã€é”™è¯¯ç‡ï¼‰ - **å·²å®ç°**: `ComputeMetrics` + `SchedulingMetrics`

**æµ‹è¯•è¦†ç›–ç‡**: ~70%
- âœ… å•å…ƒæµ‹è¯•: `tests/test_pecj_plugin.cpp`, `tests/test_window_scheduler.cpp`
- âœ… é›†æˆæµ‹è¯•: `tests/test_integrated_mode.cpp`
- â³ æ€§èƒ½æµ‹è¯•: æ¡†æ¶å·²æœ‰ï¼Œéœ€å¤§è§„æ¨¡æ•°æ®é›†éªŒè¯
- â³ å‹åŠ›æµ‹è¯•: å¾…è¡¥å……

## å·²å®ç°ä½†æ–‡æ¡£æœªæ¶µç›–çš„åŠŸèƒ½

### 1. FaultDetectionAdapter
**ä½ç½®**: `include/sage_tsdb/plugins/adapters/fault_detection_adapter.h`

å¦ä¸€ä¸ªç®—æ³•æ’ä»¶ï¼Œç”¨äºå·¥ä¸š IoT æ•…éšœæ£€æµ‹ï¼š
- å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®åˆ†æ
- å¼‚å¸¸æ£€æµ‹ç®—æ³•
- ä¸ PECJ ç±»ä¼¼çš„æ’ä»¶æ¶æ„

### 2. TableManager
**ä½ç½®**: `include/sage_tsdb/core/table_manager.h` + `src/core/table_manager.cpp`

å¤šè¡¨ç®¡ç†å™¨ï¼Œè´Ÿè´£ï¼š
- è¡¨åˆ›å»ºå’Œé”€æ¯çš„é›†ä¸­ç®¡ç†
- è¡¨ååˆ°è¡¨å®ä¾‹çš„æ˜ å°„
- è¡¨ç±»å‹ï¼ˆStream, JoinResult, ComputeStateï¼‰è·¯ç”±
- å†…å­˜å’Œç£ç›˜èµ„æºåè°ƒ

### 3. PluginManager
**ä½ç½®**: `include/sage_tsdb/plugins/plugin_manager.h` + `src/plugins/plugin_manager.cpp`

æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼š
- åŠ¨æ€æ’ä»¶åŠ è½½/å¸è½½
- æ’ä»¶ä¾èµ–ç®¡ç†
- æ’ä»¶é—´é€šä¿¡åè°ƒ
- ResourceManager çš„åˆ›å»ºå’Œåˆ†é…

### 4. æŒä¹…åŒ–å±‚å®Œæ•´å®ç°
**LSM-Tree**: `include/sage_tsdb/core/lsm_tree.h` + `src/core/lsm_tree.cpp`
- å¤šçº§åˆå¹¶ç­–ç•¥
- å‹ç¼©å’Œå»é‡
- WAL (Write-Ahead Log) æ”¯æŒ
- å´©æºƒæ¢å¤æœºåˆ¶

### 5. ç´¢å¼•ç³»ç»Ÿ
**TimeSeriesIndex**: `include/sage_tsdb/core/time_series_index.h` + `src/core/time_series_index.cpp`
- æ—¶é—´æˆ³ç´¢å¼• (B+ Tree)
- æ ‡ç­¾å€’æ’ç´¢å¼•
- å¤åˆæŸ¥è¯¢ä¼˜åŒ–

### 6. Python ç»‘å®šï¼ˆéƒ¨åˆ†ï¼‰
**ä½ç½®**: `python/bindings.cpp`
- åŸºç¡€çš„ Python æ¥å£æš´éœ²
- æ”¯æŒæ•°æ®æ’å…¥å’ŒæŸ¥è¯¢
- âš ï¸ PECJ è®¡ç®—æ¥å£å°šæœªå®Œå…¨ç»‘å®š

### 7. æ€§èƒ½åŸºå‡†æµ‹è¯•æ¡†æ¶
**ä½ç½®**: `examples/performance_benchmark.cpp`
- ååé‡æµ‹è¯•
- å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡
- å†…å­˜å ç”¨ç›‘æ§
- CPU ä½¿ç”¨ç‡é‡‡æ ·

## CMake æ„å»ºé…ç½®ï¼ˆæ”¯æŒåŒæ¨¡å¼ï¼‰

**âœ… å·²å®ç°**: å®Œæ•´çš„åŒæ¨¡å¼æ„å»ºç³»ç»Ÿ

**å®ç°æ–‡ä»¶**: `CMakeLists.txt` (æ ¹ç›®å½•)

**å®ç°ç‰¹æ€§**:
- âœ… PECJ_MODE é€‰æ‹© (PLUGIN / INTEGRATED)
- âœ… PECJ_FULL_INTEGRATION å¼€å…³
- âœ… æ¡ä»¶ç¼–è¯‘å® (PECJ_MODE_PLUGIN, PECJ_MODE_INTEGRATED)
- âœ… è‡ªåŠ¨æŸ¥æ‰¾ PECJ åº“å’Œ Torch
- âœ… æ¨¡å—åŒ–æ„å»º (sage_tsdb_core, sage_tsdb_compute, sage_tsdb_plugins)

### é¢„ç¼–è¯‘å‚æ•°

```cmake
# ========== PECJ é›†æˆæ€»å¼€å…³ ==========
option(SAGE_TSDB_ENABLE_PECJ "Enable PECJ integration" OFF)

# ========== PECJ è¿è¡Œæ¨¡å¼é€‰æ‹© ==========
set(PECJ_MODE "PLUGIN" CACHE STRING "PECJ integration mode: PLUGIN or INTEGRATED")
set_property(CACHE PECJ_MODE PROPERTY STRINGS "PLUGIN" "INTEGRATED")

# ========== PECJ æºç è·¯å¾„ ==========
set(PECJ_DIR "" CACHE PATH "Path to PECJ source or build directory")

if(SAGE_TSDB_ENABLE_PECJ)
    message(STATUS "PECJ Integration Enabled: Mode=${PECJ_MODE}")
    
    # æŸ¥æ‰¾ PECJ åº“
    find_package(PECJ REQUIRED PATHS ${PECJ_DIR})
    
    # æ ¹æ®æ¨¡å¼å®šä¹‰ä¸åŒçš„ç¼–è¯‘å®
    if(PECJ_MODE STREQUAL "PLUGIN")
        add_definitions(-DPECJ_MODE_PLUGIN)
        message(STATUS "  - Using PLUGIN mode (traditional adapter)")
        
        # æ„å»ºä¼ ç»Ÿæ’ä»¶æ¨¡å¼
        add_library(sage_tsdb_pecj_plugin
            src/plugins/adapters/pecj_adapter.cpp
            src/plugins/adapters/pecj_plugin_impl.cpp
        )
        target_link_libraries(sage_tsdb_pecj_plugin 
            PRIVATE PECJ::core
            PRIVATE sage_tsdb_core
        )
        
    elseif(PECJ_MODE STREQUAL "INTEGRATED")
        add_definitions(-DPECJ_MODE_INTEGRATED)
        message(STATUS "  - Using INTEGRATED mode (deep fusion)")
        
        # æ„å»ºæ·±åº¦èåˆæ¨¡å¼
        add_library(sage_tsdb_pecj_engine
            src/compute/pecj_compute_engine.cpp
            src/compute/pecj_data_adapter.cpp
            src/compute/window_scheduler.cpp
            src/compute/compute_state_manager.cpp
        )
        target_link_libraries(sage_tsdb_pecj_engine 
            PRIVATE PECJ::core
            PRIVATE sage_tsdb_core
        )
        
    else()
        message(FATAL_ERROR "Invalid PECJ_MODE: ${PECJ_MODE}. Must be PLUGIN or INTEGRATED")
    endif()
    
    # é€šç”¨ç¼–è¯‘å®ï¼ˆä¸¤ç§æ¨¡å¼éƒ½éœ€è¦ï¼‰
    add_definitions(-DPECJ_FULL_INTEGRATION)
    
else()
    message(STATUS "PECJ Integration Disabled - using stub implementation")
    add_definitions(-DPECJ_STUB_MODE)
endif()
```

### æ„å»ºç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šæ„å»ºæ’ä»¶æ¨¡å¼ï¼ˆç”¨äºæ€§èƒ½åŸºå‡†ï¼‰
```bash
cd sageTSDB/build
cmake .. \
    -DSAGE_TSDB_ENABLE_PECJ=ON \
    -DPECJ_MODE=PLUGIN \
    -DPECJ_DIR=/path/to/PECJ
make -j8
```

#### ç¤ºä¾‹ 2ï¼šæ„å»ºæ·±åº¦èåˆæ¨¡å¼ï¼ˆç”¨äºç”Ÿäº§ï¼‰
```bash
cd sageTSDB/build
cmake .. \
    -DSAGE_TSDB_ENABLE_PECJ=ON \
    -DPECJ_MODE=INTEGRATED \
    -DPECJ_DIR=/path/to/PECJ
make -j8
```

#### ç¤ºä¾‹ 3ï¼šæ„å»ºä¸¤ç§æ¨¡å¼ç”¨äºå¯¹æ¯”å®éªŒ
```bash
# æ„å»ºæ’ä»¶æ¨¡å¼
mkdir -p build_plugin && cd build_plugin
cmake .. -DSAGE_TSDB_ENABLE_PECJ=ON -DPECJ_MODE=PLUGIN -DPECJ_DIR=/path/to/PECJ
make -j8

# æ„å»ºæ·±åº¦èåˆæ¨¡å¼
cd ..
mkdir -p build_integrated && cd build_integrated
cmake .. -DSAGE_TSDB_ENABLE_PECJ=ON -DPECJ_MODE=INTEGRATED -DPECJ_DIR=/path/to/PECJ
make -j8

# è¿è¡Œæ€§èƒ½å¯¹æ¯”
./build_plugin/bin/pecj_benchmark > results_plugin.txt
./build_integrated/bin/pecj_benchmark > results_integrated.txt
python scripts/compare_performance.py results_plugin.txt results_integrated.txt
```

### ä»£ç ä¸­çš„æ¡ä»¶ç¼–è¯‘

```cpp
// ========== include/sage_tsdb/pecj_integration.h ==========
#pragma once

#ifdef PECJ_MODE_PLUGIN
    // ä¼ ç»Ÿæ’ä»¶æ¨¡å¼å¤´æ–‡ä»¶
    #include "plugins/adapters/pecj_adapter.h"
    using PECJInterface = sage_tsdb::plugins::PECJAdapter;
    
#elif defined(PECJ_MODE_INTEGRATED)
    // æ·±åº¦èåˆæ¨¡å¼å¤´æ–‡ä»¶
    #include "compute/pecj_compute_engine.h"
    using PECJInterface = sage_tsdb::compute::PECJComputeEngine;
    
#else
    // Stub æ¨¡å¼ï¼ˆæ—  PECJï¼‰
    #include "plugins/adapters/pecj_stub.h"
    using PECJInterface = sage_tsdb::plugins::PECJStub;
#endif

// ========== ä½¿ç”¨ç»Ÿä¸€æ¥å£ ==========
class TimeSeriesDB {
public:
    void setupPECJ(const Config& config) {
        #ifdef PECJ_MODE_PLUGIN
            // æ’ä»¶æ¨¡å¼åˆå§‹åŒ–
            pecj_ = std::make_unique<PECJAdapter>(config);
            pecj_->initialize(config);
            pecj_->start();
            
        #elif defined(PECJ_MODE_INTEGRATED)
            // æ·±åº¦èåˆæ¨¡å¼åˆå§‹åŒ–
            auto handle = resource_manager_->allocateForCompute("pecj", resource_req);
            pecj_ = std::make_unique<PECJComputeEngine>();
            pecj_->initialize(config, this, handle.get());
            
        #else
            // Stub æ¨¡å¼
            pecj_ = std::make_unique<PECJStub>();
        #endif
    }
    
private:
    std::unique_ptr<PECJInterface> pecj_;
};
```

## æ€§èƒ½å¯¹æ¯”å®éªŒæŒ‡å—

### å®éªŒç¯å¢ƒå‡†å¤‡

```bash
# 1. æ„å»ºä¸¤ç§æ¨¡å¼
./scripts/build_dual_mode.sh

# 2. ç”Ÿæˆæµ‹è¯•æ•°æ®é›†
./scripts/generate_test_data.sh \
    --events 10000000 \
    --out-of-order-ratio 0.2 \
    --streams 2

# 3. è¿è¡Œæ€§èƒ½æµ‹è¯•
./scripts/run_benchmark.sh \
    --mode both \
    --config configs/pecj_benchmark.json \
    --output results/
```

### å®éªŒé…ç½®æ¨¡æ¿

```json
{
  "experiment": {
    "name": "PECJ Plugin vs Integrated Performance Comparison",
    "runs": 5,
    "warmup_runs": 2
  },
  "workload": {
    "total_events": 10000000,
    "window_size_ms": 1000,
    "slide_size_ms": 500,
    "out_of_order_ratio": 0.2,
    "key_range": 1000
  },
  "modes": [
    {
      "name": "plugin",
      "config": {
        "threads": 4,
        "buffer_size": 100000
      }
    },
    {
      "name": "integrated",
      "config": {
        "threads": 4,
        "max_memory_mb": 2048
      }
    }
  ],
  "metrics": [
    "throughput_events_per_sec",
    "latency_p50_ms",
    "latency_p99_ms",
    "memory_peak_mb",
    "memory_avg_mb",
    "cpu_usage_percent"
  ]
}
```

### æ€§èƒ½æŒ‡æ ‡æ”¶é›†

```cpp
// ========== src/benchmark/performance_collector.h ==========
struct PerformanceMetrics {
    // æ¨¡å¼æ ‡è¯†
    std::string mode;  // "plugin" or "integrated"
    
    // ååé‡æŒ‡æ ‡
    uint64_t total_events;
    double duration_seconds;
    double throughput_events_per_sec;
    
    // å»¶è¿ŸæŒ‡æ ‡ (microseconds)
    double latency_min;
    double latency_max;
    double latency_avg;
    double latency_p50;
    double latency_p95;
    double latency_p99;
    double latency_p999;
    
    // èµ„æºæŒ‡æ ‡
    size_t memory_peak_bytes;
    size_t memory_avg_bytes;
    int threads_used;
    double cpu_usage_percent;
    
    // PECJ ç‰¹å®šæŒ‡æ ‡
    uint64_t windows_completed;
    uint64_t join_results_count;
    double avg_window_latency_ms;
    
    // æ¨¡å¼å·®å¼‚
    bool has_data_duplication;  // Plugin: true, Integrated: false
    bool uses_internal_threads; // Plugin: true, Integrated: false
};

// å¯¹æ¯”æŠ¥å‘Šç”Ÿæˆ
void generateComparisonReport(
    const PerformanceMetrics& plugin_metrics,
    const PerformanceMetrics& integrated_metrics) {
    
    std::cout << "=== PECJ Performance Comparison ===" << std::endl;
    std::cout << "Throughput: " << std::endl;
    std::cout << "  Plugin:     " << plugin_metrics.throughput_events_per_sec << " events/s" << std::endl;
    std::cout << "  Integrated: " << integrated_metrics.throughput_events_per_sec << " events/s" << std::endl;
    std::cout << "  Speedup:    " << (integrated_metrics.throughput_events_per_sec / plugin_metrics.throughput_events_per_sec) << "x" << std::endl;
    
    // ... æ›´å¤šå¯¹æ¯”è¾“å‡º
}
```

### å¯è§†åŒ–å¯¹æ¯”è„šæœ¬

```python
# scripts/compare_performance.py
import json
import matplotlib.pyplot as plt

def plot_comparison(plugin_results, integrated_results):
    metrics = ['throughput', 'latency_p99', 'memory_peak', 'cpu_usage']
    
    fig, axes = plt.subplots(2, 2, figsize=(15, 12))
    
    # ååé‡å¯¹æ¯”
    axes[0, 0].bar(['Plugin', 'Integrated'], 
                   [plugin_results['throughput'], integrated_results['throughput']])
    axes[0, 0].set_title('Throughput (events/sec)')
    
    # å»¶è¿Ÿå¯¹æ¯”
    axes[0, 1].bar(['Plugin', 'Integrated'],
                   [plugin_results['latency_p99'], integrated_results['latency_p99']])
    axes[0, 1].set_title('P99 Latency (ms)')
    
    # å†…å­˜å¯¹æ¯”
    axes[1, 0].bar(['Plugin', 'Integrated'],
                   [plugin_results['memory_peak'], integrated_results['memory_peak']])
    axes[1, 0].set_title('Peak Memory (MB)')
    
    # CPU å¯¹æ¯”
    axes[1, 1].bar(['Plugin', 'Integrated'],
                   [plugin_results['cpu_usage'], integrated_results['cpu_usage']])
    axes[1, 1].set_title('CPU Usage (%)')
    
    plt.savefig('pecj_performance_comparison.png')
```

## æœªå®ç°åŠŸèƒ½æ¸…å•ï¼ˆRoadmapï¼‰

### é«˜ä¼˜å…ˆçº§ï¼ˆP0 - ç”Ÿäº§å¿…éœ€ï¼‰
1. **GPU èµ„æºç®¡ç†** âŒ
   - ResourceManager ä¸­ `gpu_ids` ä»…ä¸ºæ¥å£é¢„ç•™
   - éœ€è¦å®ç° CUDA è®¾å¤‡åˆ†é…å’Œè°ƒåº¦
   - éœ€è¦ GPU å†…å­˜é…é¢ç®¡ç†
   - **é¢„è®¡å·¥ä½œé‡**: 2-3 å‘¨

2. **è‡ªåŠ¨é™çº§è§¦å‘é€»è¾‘å®Œå–„** âš ï¸
   - `fallbackToAQP()` å·²å®ç°ï¼Œä½†è§¦å‘æ¡ä»¶ä¸å®Œæ•´
   - éœ€è¦åŸºäºè¶…æ—¶ã€å†…å­˜å‹åŠ›ã€é”™è¯¯ç‡è‡ªåŠ¨åˆ‡æ¢
   - **é¢„è®¡å·¥ä½œé‡**: 1 å‘¨

3. **å¤§è§„æ¨¡æ€§èƒ½éªŒè¯** â³
   - ç™¾ä¸‡çº§äº‹ä»¶æµæµ‹è¯•
   - å¤šçª—å£å¹¶å‘å‹åŠ›æµ‹è¯•
   - é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•
   - **é¢„è®¡å·¥ä½œé‡**: 2 å‘¨

### ä¸­ä¼˜å…ˆçº§ï¼ˆP1 - åŠŸèƒ½å¢å¼ºï¼‰
4. **åˆ†å¸ƒå¼è®¡ç®—æ”¯æŒ** âŒ
   - è¡¨åˆ†ç‰‡ (sharding) æœºåˆ¶
   - è·¨èŠ‚ç‚¹ä»»åŠ¡è°ƒåº¦
   - åˆ†å¸ƒå¼çŠ¶æ€ä¸€è‡´æ€§
   - **é¢„è®¡å·¥ä½œé‡**: 4-6 å‘¨

5. **Python å®Œæ•´ç»‘å®š** âš ï¸
   - PECJ è®¡ç®—æ¥å£æš´éœ²
   - WindowScheduler é…ç½®æ¥å£
   - å›è°ƒå‡½æ•°æ”¯æŒ
   - **é¢„è®¡å·¥ä½œé‡**: 1-2 å‘¨

6. **çƒ­åˆ‡æ¢æ¨¡å¼** âŒ
   - è¿è¡Œæ—¶åœ¨æ’ä»¶æ¨¡å¼å’Œæ·±åº¦èåˆæ¨¡å¼é—´åˆ‡æ¢
   - é›¶åœæœºè¿ç§»
   - çŠ¶æ€å¹³æ»‘è½¬ç§»
   - **é¢„è®¡å·¥ä½œé‡**: 3-4 å‘¨

### ä½ä¼˜å…ˆçº§ï¼ˆP2 - ä¼˜åŒ–å’Œæ‰©å±•ï¼‰
7. **å¤šè®¡ç®—å¼•æ“æ¡†æ¶** âš ï¸
   - `IComputeEngine` ç»Ÿä¸€æ¥å£ï¼ˆéƒ¨åˆ†è®¾è®¡ï¼‰
   - è®¡ç®—å¼•æ“æ³¨å†Œå’Œå‘ç°æœºåˆ¶
   - èµ„æºåœ¨å¤šå¼•æ“é—´åŠ¨æ€åˆ†é…
   - **é¢„è®¡å·¥ä½œé‡**: 2 å‘¨

8. **é«˜çº§ç›‘æ§å’Œå¯è§†åŒ–** âš ï¸
   - Prometheus/Grafana é›†æˆ
   - å®æ—¶æŒ‡æ ‡ä»ªè¡¨æ¿
   - å‘Šè­¦è§„åˆ™å¼•æ“
   - **é¢„è®¡å·¥ä½œé‡**: 1-2 å‘¨

9. **è‡ªé€‚åº”å‚æ•°è°ƒä¼˜** âŒ
   - åŸºäºå†å²æŒ‡æ ‡è‡ªåŠ¨è°ƒæ•´çª—å£å¤§å°
   - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—å­ (IAWJ vs PAWJ)
   - åŠ¨æ€çº¿ç¨‹æ± å¤§å°
   - **é¢„è®¡å·¥ä½œé‡**: 3-4 å‘¨

## åç»­æ‰©å±•

### å·²è§„åˆ’çš„æ¶æ„æ‰©å±•

1. **å¤šè®¡ç®—å¼•æ“æ”¯æŒ** âš ï¸ éƒ¨åˆ†è®¾è®¡
   - å®ç°ç»Ÿä¸€çš„ `IComputeEngine` æ¥å£
   - æ”¯æŒæ³¨å†Œå¤šä¸ªè®¡ç®—å¼•æ“ï¼ˆPECJã€Fault Detectionã€Anomaly Detectionï¼‰
   - **å½“å‰çŠ¶æ€**: FaultDetectionAdapter å·²å®ç°ï¼Œä½†ç¼ºä¹ç»Ÿä¸€æŠ½è±¡

2. **åˆ†å¸ƒå¼è®¡ç®—** âŒ æœªå®ç°
   - é€šè¿‡ sageTSDB çš„åˆ†å¸ƒå¼è¡¨ï¼ˆshardingï¼‰æ”¯æŒå¤§è§„æ¨¡è®¡ç®—
   - PECJ è®¡ç®—ä»»åŠ¡å¯è°ƒåº¦åˆ°å¤šèŠ‚ç‚¹
   - **æŠ€æœ¯è·¯çº¿**: åŸºäº gRPC çš„è¿œç¨‹è®¡ç®—å¼•æ“è°ƒç”¨

3. **GPU åŠ é€Ÿ** âš ï¸ æ¥å£é¢„ç•™
   - ResourceManager è‡ªåŠ¨åˆ†é… GPU è®¾å¤‡
   - PECJ è®¡ç®—åœ¨ GPU ä¸Šæ‰§è¡Œï¼ˆéœ€ PECJ æ”¯æŒï¼‰
   - **ä¾èµ–**: PECJ éœ€å…ˆæ”¯æŒ GPU ç®—å­

4. **è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢** âŒ æœªå®ç°
   - è¿è¡Œæ—¶æ ¹æ®è´Ÿè½½åŠ¨æ€åˆ‡æ¢æ¨¡å¼
   - æ’ä»¶æ¨¡å¼ â†” æ·±åº¦èåˆæ¨¡å¼çƒ­åˆ‡æ¢
   - **æŒ‘æˆ˜**: çŠ¶æ€è¿ç§»å’Œæ•°æ®ä¸€è‡´æ€§ä¿è¯

## å¸¸è§é—®é¢˜ (FAQ)

### Q1: æ•°æ®ä»å¤–éƒ¨åˆ° PECJ è®¡ç®—çš„å®Œæ•´æµç¨‹ï¼Ÿ
```
1. å¤–éƒ¨æ•°æ®æº â†’ TimeSeriesDB::insert("stream_s", data)
2. sageTSDB å†™å…¥ MemTableï¼Œå¿…è¦æ—¶ flush åˆ° LSM-Tree
3. WindowScheduler æ£€æµ‹çª—å£å®Œæ•´ â†’ è§¦å‘è®¡ç®—
4. PECJComputeEngine::executeWindowJoin() æ‰§è¡Œï¼š
   a. ä» stream_s/stream_r è¡¨æŸ¥è¯¢çª—å£æ•°æ®
   b. è°ƒç”¨ PECJ æ ¸å¿ƒç®—æ³•
   c. å°†ç»“æœå†™å…¥ join_results è¡¨
5. EventBus å‘å¸ƒ "window_completed" äº‹ä»¶
6. ä¸‹æ¸¸åº”ç”¨é€šè¿‡ query("join_results") è·å–ç»“æœ
```

### Q2: PECJ çš„çŠ¶æ€ï¼ˆå¦‚ watermarkã€çª—å£è¿›åº¦ï¼‰å¦‚ä½•ç®¡ç†ï¼Ÿ
æ‰€æœ‰çŠ¶æ€éƒ½åºåˆ—åŒ–åå­˜å‚¨åœ¨ sageTSDB çš„ç‰¹æ®Šè¡¨ `_compute_state` ä¸­ï¼š
```cpp
// ä¿å­˜çŠ¶æ€
db.insert("_compute_state", {
    .tags = {{"compute_name", "pecj_engine"}},
    .fields = {{"watermark", current_watermark},
               {"window_id", current_window_id}},
    .payload = serialized_operator_state
});

// æ¢å¤çŠ¶æ€
auto state_data = db.query("_compute_state", {
    .filter_tags = {{"compute_name", "pecj_engine"}}
});
pecj_engine.restoreState(state_data[0].payload);
```

### Q3: å¦‚ä½•ä¿è¯ PECJ è®¡ç®—çš„å®æ—¶æ€§ï¼Ÿ
1. **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šé«˜ä¼˜å…ˆçº§çª—å£ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œ
2. **å¢é‡è®¡ç®—**ï¼šæ¯ä¸ªçª—å£ç‹¬ç«‹è®¡ç®—ï¼Œä¸é˜»å¡åç»­çª—å£
3. **è¶…æ—¶é™çº§**ï¼šè¶…è¿‡é˜ˆå€¼è‡ªåŠ¨åˆ‡æ¢åˆ° AQP æ¨¡å¼ï¼ˆç‰ºç‰²ç²¾åº¦æ¢é€Ÿåº¦ï¼‰
4. **é¢„å–ä¼˜åŒ–**ï¼šWindowScheduler æå‰å°†æ•°æ®åŠ è½½åˆ° MemTable

### Q4: å¦‚ä½•å¤„ç†ä¹±åºæ•°æ®ï¼ˆout-of-orderï¼‰ï¼Ÿ
sageTSDB çš„è¡¨æ”¯æŒä¹±åºæ’å…¥ï¼š
```cpp
// å³ä½¿æ—¶é—´æˆ³ä¹±åºï¼Œä¹Ÿèƒ½æ­£ç¡®æ’å…¥
db.insert("stream_s", {.timestamp = t1, ...});
db.insert("stream_s", {.timestamp = t0, ...});  // t0 < t1

// PECJ æŸ¥è¯¢æ—¶ä¼šè‡ªåŠ¨æŒ‰æ—¶é—´æ’åº
auto data = db.query("stream_s", time_range);  // å·²æ’åº
```

### Q5: å¦‚ä½•åœ¨æ’ä»¶æ¨¡å¼å’Œæ·±åº¦èåˆæ¨¡å¼ä¹‹é—´åˆ‡æ¢ï¼Ÿ
**åŒæ¨¡å¼å…±å­˜**ï¼Œé€šè¿‡ CMake å‚æ•°é€‰æ‹©ï¼š

```bash
# ä½¿ç”¨æ’ä»¶æ¨¡å¼ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
cmake -DPECJ_MODE=PLUGIN ..

# ä½¿ç”¨æ·±åº¦èåˆæ¨¡å¼
cmake -DPECJ_MODE=INTEGRATED ..
```

**è¿è¡Œæ—¶è¡Œä¸ºå·®å¼‚**ï¼š
- **æ’ä»¶æ¨¡å¼**ï¼šä½¿ç”¨ `feedData()` å¼‚æ­¥è¾“å…¥ï¼ŒPECJ å†…éƒ¨ç®¡ç†ç¼“å†²åŒºå’Œçº¿ç¨‹
- **æ·±åº¦èåˆæ¨¡å¼**ï¼šæ•°æ®å…ˆ `db->insert()`ï¼Œé€šè¿‡ WindowScheduler è§¦å‘è®¡ç®—

**ä»£ç å…¼å®¹æ€§**ï¼š
```cpp
#ifdef PECJ_MODE_PLUGIN
    // æ’ä»¶æ¨¡å¼ä»£ç 
    pecj_adapter->feedStreamS(data);
#elif defined(PECJ_MODE_INTEGRATED)
    // æ·±åº¦èåˆæ¨¡å¼ä»£ç 
    db->insert("stream_s", data);
#endif
```

### Q6: å¦‚ä½•è°ƒè¯• PECJ è®¡ç®—é—®é¢˜ï¼Ÿ
sageTSDB æä¾›å®Œæ•´çš„è°ƒè¯•èƒ½åŠ›ï¼š
```cpp
// 1. æŸ¥è¯¢è¾“å…¥æ•°æ®
auto s_data = db.query("stream_s", window_time_range);
auto r_data = db.query("stream_r", window_time_range);

// 2. æ‰‹åŠ¨è§¦å‘è®¡ç®—ï¼ˆè·³è¿‡ WindowSchedulerï¼‰
auto status = pecj_engine.executeWindowJoin(window_id, time_range);

// 3. æ£€æŸ¥ä¸­é—´çŠ¶æ€
auto state = db.query("_compute_state", {
    .filter_tags = {{"compute_name", "pecj_engine"}}
});

// 4. éªŒè¯è¾“å‡º
auto results = db.query("join_results", {
    .filter_tags = {{"window_id", std::to_string(window_id)}}
});
```

### Q7: å¤šä¸ª PECJ å®ä¾‹å¦‚ä½•éš”ç¦»ï¼Ÿ
é€šè¿‡ ResourceManager çš„èµ„æºé…é¢éš”ç¦»ï¼š
```cpp
// ä¸ºä¸åŒæŸ¥è¯¢åˆ†é…ç‹¬ç«‹çš„è®¡ç®—å¼•æ“
auto pecj_query1 = db.createComputeEngine("pecj_q1", {
    .requested_threads = 2,
    .max_memory_bytes = 1GB
});

auto pecj_query2 = db.createComputeEngine("pecj_q2", {
    .requested_threads = 2,
    .max_memory_bytes = 1GB
});

// èµ„æºæ€»å’Œä¸è¶…è¿‡ç³»ç»Ÿé…é¢
```

## å®ç°æ³¨æ„äº‹é¡¹

### 1. çº¿ç¨‹å®‰å…¨
- `PECJComputeEngine` çš„æ‰€æœ‰å…¬å…±æ–¹æ³•å¿…é¡»çº¿ç¨‹å®‰å…¨
- å¤šä¸ªçª—å£å¯èƒ½å¹¶å‘è°ƒç”¨ `executeWindowJoin()`
- ä½¿ç”¨ `std::shared_mutex` ä¿æŠ¤å…±äº«çŠ¶æ€

### 2. å†…å­˜ç®¡ç†
```cpp
class PECJComputeEngine {
private:
    // ä½¿ç”¨ Arena åˆ†é…å™¨å‡å°‘ç¢ç‰‡
    std::unique_ptr<MemoryArena> arena_;
    
    // å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨
    void checkMemoryUsage() {
        if (arena_->usage() > config_.max_memory_bytes) {
            // è§¦å‘æ¸…ç†æˆ–é™çº§
            cleanupOldWindows();
        }
    }
};
```

### 3. é”™è¯¯å¤„ç†
```cpp
ComputeStatus PECJComputeEngine::executeWindowJoin(...) {
    try {
        // æŸ¥è¯¢æ•°æ®
        auto s_data = db_->query("stream_s", time_range);
        auto r_data = db_->query("stream_r", time_range);
        
        // æ‰§è¡Œè®¡ç®—
        auto result = pecj_operator_->join(s_data, r_data);
        
        // å†™å›ç»“æœ
        db_->insert("join_results", result);
        
        return {.success = true, .join_count = result.size()};
        
    } catch (const std::exception& e) {
        // è®°å½•é”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
        LOG_ERROR("PECJ computation failed: {}", e.what());
        return {.success = false, .error = e.what()};
    }
}
```

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **æ‰¹é‡æŸ¥è¯¢**ï¼šä¸€æ¬¡æŸ¥è¯¢æ•´ä¸ªçª—å£ï¼Œè€Œéé€æ¡æŸ¥è¯¢
- **é›¶æ‹·è´**ï¼šä½¿ç”¨ `std::shared_ptr` åœ¨ sageTSDB å’Œ PECJ é—´å…±äº«æ•°æ®
- **å¼‚æ­¥å†™å…¥**ï¼šè®¡ç®—ç»“æœå¼‚æ­¥å†™å…¥è¡¨ï¼Œä¸é˜»å¡ä¸‹ä¸€ä¸ªçª—å£
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨æ—¶é—´æˆ³å­—æ®µå»ºç«‹ç´¢å¼•åŠ é€Ÿçª—å£æŸ¥è¯¢

### 5. ç›‘æ§æŒ‡æ ‡
å¿…é¡»ä¸ŠæŠ¥çš„å…³é”®æŒ‡æ ‡ï¼š
```cpp
struct PECJMetrics {
    // ååé‡
    uint64_t windows_completed;
    uint64_t tuples_processed;
    
    // å»¶è¿Ÿ
    double avg_window_latency_ms;
    double p99_window_latency_ms;
    
    // èµ„æº
    size_t peak_memory_bytes;
    int active_threads;
    
    // è´¨é‡
    double avg_join_selectivity;  // join_count / (|S| * |R|)
    double aqp_error_rate;        // |exact - aqp| / exact
    
    // é”™è¯¯
    uint64_t failed_windows;
    uint64_t retries;
};
```

## é™„å½•ï¼šä»£ç ç´¢å¼•

### æ ¸å¿ƒæ¨¡å—æ–‡ä»¶åˆ—è¡¨

#### Compute å±‚ï¼ˆæ·±åº¦èåˆæ¨¡å¼ï¼‰
```
include/sage_tsdb/compute/
â”œâ”€â”€ pecj_compute_engine.h       # PECJ æ— çŠ¶æ€è®¡ç®—å¼•æ“
â”œâ”€â”€ window_scheduler.h          # çª—å£è°ƒåº¦å™¨
â””â”€â”€ compute_state_manager.h     # çŠ¶æ€ç®¡ç†å™¨

src/compute/
â”œâ”€â”€ pecj_compute_engine.cpp     # å®ç° (301 è¡Œ)
â”œâ”€â”€ window_scheduler.cpp        # å®ç° (540+ è¡Œ)
â””â”€â”€ compute_state_manager.cpp   # å®ç° (188 è¡Œ)
```

#### Core å±‚ï¼ˆå­˜å‚¨å’Œè¡¨ï¼‰
```
include/sage_tsdb/core/
â”œâ”€â”€ time_series_db.h            # æ•°æ®åº“ä¸»æ¥å£
â”œâ”€â”€ stream_table.h              # è¾“å…¥æµè¡¨
â”œâ”€â”€ join_result_table.h         # Join ç»“æœè¡¨
â”œâ”€â”€ lsm_tree.h                  # LSM-Tree æŒä¹…åŒ–
â”œâ”€â”€ table_manager.h             # å¤šè¡¨ç®¡ç†
â””â”€â”€ time_series_index.h         # ç´¢å¼•ç³»ç»Ÿ

src/core/
â”œâ”€â”€ time_series_db.cpp
â”œâ”€â”€ stream_table.cpp            # MemTable + LSM å®ç°
â”œâ”€â”€ join_result_table.cpp       # 259 è¡Œ
â”œâ”€â”€ lsm_tree.cpp                # å®Œæ•´ LSM-Tree
â”œâ”€â”€ table_manager.cpp
â””â”€â”€ time_series_index.cpp
```

#### Plugins å±‚ï¼ˆæ’ä»¶æ¨¡å¼ï¼‰
```
include/sage_tsdb/plugins/
â”œâ”€â”€ plugin_manager.h            # æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ resource_manager.h          # èµ„æºç»Ÿä¸€ç®¡ç†
â”œâ”€â”€ event_bus.h                 # äº‹ä»¶é€šçŸ¥ç³»ç»Ÿ
â””â”€â”€ adapters/
    â”œâ”€â”€ pecj_adapter.h          # PECJ æ’ä»¶æ¨¡å¼é€‚é…å™¨
    â””â”€â”€ fault_detection_adapter.h

src/plugins/
â”œâ”€â”€ plugin_manager.cpp
â”œâ”€â”€ resource_manager.cpp        # çº¿ç¨‹æ± å’Œé…é¢å®ç°
â””â”€â”€ adapters/
    â”œâ”€â”€ pecj_adapter.cpp        # 257 è¡Œ
    â””â”€â”€ fault_detection_adapter.cpp
```

#### Examplesï¼ˆä½¿ç”¨ç¤ºä¾‹ï¼‰
```
examples/
â”œâ”€â”€ deep_integration_demo.cpp       # æ·±åº¦èåˆæ¨¡å¼å®Œæ•´ç¤ºä¾‹
â”œâ”€â”€ window_scheduler_demo.cpp       # WindowScheduler ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ plugin_usage_example.cpp        # æ’ä»¶æ¨¡å¼ç¤ºä¾‹
â”œâ”€â”€ performance_benchmark.cpp       # æ€§èƒ½æµ‹è¯•æ¡†æ¶
â”œâ”€â”€ persistence_example.cpp         # æŒä¹…åŒ–ç¤ºä¾‹
â””â”€â”€ table_design_demo.cpp           # å¤šè¡¨ä½¿ç”¨ç¤ºä¾‹
```

#### Testsï¼ˆæµ‹è¯•ï¼‰
```
tests/
â”œâ”€â”€ test_pecj_plugin.cpp            # PECJ æ’ä»¶æµ‹è¯•
â”œâ”€â”€ test_integrated_mode.cpp        # æ·±åº¦èåˆæ¨¡å¼é›†æˆæµ‹è¯•
â”œâ”€â”€ test_window_scheduler.cpp       # WindowScheduler å•å…ƒæµ‹è¯•
â”œâ”€â”€ test_resource_manager.cpp       # ResourceManager æµ‹è¯•
â”œâ”€â”€ test_table_design.cpp           # è¡¨è®¾è®¡æµ‹è¯•
â””â”€â”€ test_storage_engine.cpp         # å­˜å‚¨å¼•æ“æµ‹è¯•
```

### ç¼–è¯‘å’Œè¿è¡Œ

#### æ„å»ºæ·±åº¦èåˆæ¨¡å¼
```bash
mkdir -p build_integrated && cd build_integrated
cmake .. \
    -DSAGE_TSDB_ENABLE_PECJ=ON \
    -DPECJ_MODE=INTEGRATED \
    -DPECJ_FULL_INTEGRATION=ON \
    -DPECJ_DIR=/path/to/PECJ \
    -DCMAKE_BUILD_TYPE=Release
make -j8
```

#### è¿è¡Œç¤ºä¾‹
```bash
# æ·±åº¦èåˆæ¨¡å¼ Demo
./build_integrated/examples/deep_integration_demo

# çª—å£è°ƒåº¦å™¨ Demo
./build_integrated/examples/window_scheduler_demo

# æ€§èƒ½åŸºå‡†æµ‹è¯•
./build_integrated/examples/performance_benchmark
```

#### è¿è¡Œæµ‹è¯•
```bash
cd build_integrated
ctest --output-on-failure
# æˆ–å•ç‹¬è¿è¡Œ
./tests/test_integrated_mode
./tests/test_window_scheduler
```

---

## æ–‡æ¡£å…ƒæ•°æ®

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1 (å®ç°çŠ¶æ€æ ‡æ³¨ç‰ˆ)  
**æœ€åæ›´æ–°**: 2024-12-09  
**ä»£ç åˆ†æ”¯**: `pecj_resource_integration`  
**å®ç°è¿›åº¦**: ~85% æ ¸å¿ƒåŠŸèƒ½å®Œæˆ  
**å®¡é˜…è€…**: PECJ å›¢é˜Ÿ + sageTSDB å›¢é˜Ÿ  
**ç»´æŠ¤è€…**: @intellistream  

**å˜æ›´å†å²**:
- v3.1 (2024-12-09): æ·»åŠ å®ç°çŠ¶æ€æ ‡æ³¨ã€ä»£ç ç´¢å¼•ã€æ¶æ„å›¾
- v3.0 (2024-12-04): åˆå§‹æ·±åº¦èåˆæ¶æ„è®¾è®¡
- v2.0 (å·²åºŸå¼ƒ): ä¼ ç»Ÿæ’ä»¶æ¨¡å¼è®¾è®¡

**ç›¸å…³æ–‡æ¡£**:
- `PECJ_INTEGRATION_FIX.md`: PECJ é›†æˆé—®é¢˜ä¿®å¤è®°å½•
- `PYTORCH_INTEGRATION_SUCCESS.md`: PyTorch/Torch é›†æˆæˆåŠŸè®°å½•
- `REFACTORING_SUMMARY.md`: é‡æ„æ€»ç»“
- `TABLE_DESIGN_IMPLEMENTATION.md`: è¡¨è®¾è®¡å®ç°ç»†èŠ‚
- `docs/PECJ_DEEP_INTEGRATION_SUMMARY.md`: æ·±åº¦èåˆæ€»ç»“

**å·²çŸ¥é—®é¢˜**:
1. GPU èµ„æºç®¡ç†ä»…ä¸ºæ¥å£é¢„ç•™ï¼Œå®é™…åˆ†é…æœªå®ç°
2. åˆ†å¸ƒå¼è®¡ç®—å°šæœªæ”¯æŒ
3. Python ç»‘å®šä¸å®Œæ•´
4. æ€§èƒ½æµ‹è¯•æ•°æ®å¾…è¡¥å……

**ä¸‹ä¸€æ­¥è®¡åˆ’**:
- [ ] å®Œæˆå¤§è§„æ¨¡æ€§èƒ½éªŒè¯ï¼ˆç™¾ä¸‡çº§äº‹ä»¶ï¼‰
- [ ] å®ç° GPU èµ„æºç®¡ç†
- [ ] å®Œå–„è‡ªåŠ¨é™çº§é€»è¾‘
- [ ] è¡¥å…… Python å®Œæ•´ç»‘å®š
